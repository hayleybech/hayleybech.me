---
id: 0da986d9-401d-4165-bbcd-4dfb83b6d343
published: false
blueprint: article
title: 'How the email chat system works in Choir Concierge'
author:
  - 9bdb0db4-21c2-47e2-8b40-7df4732b3849
topics:
  - 30-in-30
  - choir-concierge
updated_by: 9bdb0db4-21c2-47e2-8b40-7df4732b3849
updated_at: 1733817752
---
The email chatroom system in Choir Concierge, or just "The email system" as I frequently call it, is a complicated piece of code that does something rather unusual for 2024. Join me for a deep dive on an existing section of the Concierge codebase, and we'll also take a look at some opportunities for improvement.

# What it does
- allows you to use email like a chat room
- targeted at choirs with older members
- send email to "teamname@choirname.choirconcierge.com".
- all team members receive a copy and can reply to all or reply to the sender individually. 

# How it works
- all incoming emails for all subdomains are routed to a central inbox.
- emails are filtered:
	- by subdomain for matching choirs
	- by addressee for matching mailing lists
	- by sender for users permitted to send to the list
- messages sent from emails that aren't permitted are rejected, and the user receives a rejection email.
- then the mailing list is mapped to a group of users
- finally, a duplicate of the email is sent to each user

# Issues
- it's a bitch to maintain. i should be charging separately for this feature. 
- since I can't afford the pro version of Mailgun with inbound email routing, I've had to hack together my own system. I have a regular cpanel email inbox, which I check every 5 min via IMAP.
- The API I'm using for IMAP can't seem to detect file-sizes prior to downloading messages, meaning I haven't found a way to prevent the API from trapping itself when very large emails come through.
- The system has no failure detection, but failed emails are marked unread, meaning they'll cause an infinite loop, crashing the system for all choirs.
- The system has no logging of any kind, so there's no way to know when a specific email failed, I just see an exception in Sentry and have to figure the rest out somehow. 
- The system in its current state is rife with opportunities to be overloaded, either accidentally or on purpose. For example, it would be simple enough to write a script that sends infinite emails to a non-existent address, causing infinite rejection emails to be sent.